name: Build OpenClaw Node Android

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build OpenClaw Node APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v6

      - name: Clone OpenClaw upstream
        run: |
          git clone --depth 1 https://github.com/openclaw/openclaw.git /tmp/openclaw

      - name: Copy Android app source
        run: |
          cp -r /tmp/openclaw/apps/android openclaw-node-android

      - name: Copy shared assets
        run: |
          # The app's build.gradle.kts references ../../shared/OpenClawKit/Sources/OpenClawKit/Resources
          mkdir -p openclaw-node-android/shared/OpenClawKit/Sources/OpenClawKit/Resources
          if [ -d /tmp/openclaw/shared/OpenClawKit/Sources/OpenClawKit/Resources ]; then
            cp -r /tmp/openclaw/shared/OpenClawKit/Sources/OpenClawKit/Resources/* \
              openclaw-node-android/shared/OpenClawKit/Sources/OpenClawKit/Resources/ 2>/dev/null || true
          fi

      - name: Fix assets path for standalone build
        working-directory: openclaw-node-android
        run: |
          # Rewrite assets.srcDir to point to the local shared dir instead of ../../shared
          sed -i 's|../../shared|shared|g' app/build.gradle.kts

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-node-${{ runner.os }}-${{ hashFiles('openclaw-node-android/**/*.gradle*') }}
          restore-keys: gradle-node-${{ runner.os }}-

      - name: Make gradlew executable
        working-directory: openclaw-node-android
        run: chmod +x gradlew

      - name: Build debug APK
        working-directory: openclaw-node-android
        run: ./gradlew :app:assembleDebug

      - name: Build release APK
        working-directory: openclaw-node-android
        run: ./gradlew :app:assembleRelease

      - name: Collect artifacts
        id: artifacts
        run: |
          mkdir -p artifacts

          # Get version from build.gradle.kts
          VERSION=$(grep 'versionName' openclaw-node-android/app/build.gradle.kts | head -1 | grep -oP '"[^"]+"' | tr -d '"')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Debug APK
          DEBUG_APK=$(find openclaw-node-android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          if [ -n "$DEBUG_APK" ]; then
            cp "$DEBUG_APK" "artifacts/OpenClawNode-v${VERSION}-debug.apk"
          fi

          # Release APK
          RELEASE_APK=$(find openclaw-node-android/app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$RELEASE_APK" ]; then
            cp "$RELEASE_APK" "artifacts/OpenClawNode-v${VERSION}-release.apk"
          fi

          echo "Built artifacts:"
          ls -lh artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openclaw-node-apks
          path: artifacts/*.apk
          retention-days: 30

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.apk
